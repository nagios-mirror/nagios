###############################
# Makefile for contrib software
#
# Last Modified: 04-08-2003
###############################

CC=@CC@
CFLAGS=@CFLAGS@ @DEFS@
LDFLAGS=@LDFLAGS@ @LIBS@

# Source code directories
SRC_COMMON=../common
SRC_CGI=../cgi

# Generated automatically from configure script
SNPRINTF_O=@SNPRINTF_O@
INSTALL=@INSTALL@
INSTALL_OPTS=@INSTALL_OPTS@
CGIDIR=@sbindir@

ALL=traceroute.cgi mini_epn convertcfg

CGI_C=$(SRC_CGI)/getcgi.c
CGI_O=$(SRC_CGI)/getcgi.o $(SNPRINTF_O)
CGI_H=$(SRC_CGI)/getcgi.h
COMMON_H=$(SRC_COMMON)/config.h $(SRC_COMMON)/common.h $(SRC_COMMON)/locations.h

##############################################################################
# standard targets (all, clean, distclean, devclean, install)

all: $(ALL)

clean:
	rm -f convertcfg daemonchk.cgi mini_epn core *.o
	rm -f */*/*~
	rm -f */*~
	rm -f *~

distclean: clean
	rm -f template-objects/checkcommands.cfg template-objects/misccommands.cfg
	rm -f Makefile

devclean: distclean

install:
	$(INSTALL) -m 775 $(INSTALL_OPTS) -d $(CGIDIR)
	for f in $(ALL); do $(INSTALL) -m 775 $(INSTALL_OPTS) $$f $(DESTDIR)$(CGIDIR); done

##############################################################################
# rules and dependencies for actual target programs

daemonchk.cgi: 
	@echo "This doesn't work with Nagios 2.x yet..."
#	daemonchk.c $(CGI_O) $(CGI_H) $(COMMON_H)

mini_epn: mini_epn.c
	perl -MExtUtils::Embed -e xsinit
	$(CC) $(CFLAGS) -c perlxsi.c  `perl -MExtUtils::Embed -e ccopts`
	$(CC) $(CFLAGS) -c mini_epn.c `perl -MExtUtils::Embed -e ccopts`
	$(CC) $(CFLAGS) $(LDFLAGS) perlxsi.o mini_epn.o `perl -MExtUtils::Embed -e ccopts -e ldopts` -o $@

##############################################################################
# dependencies

$(CGI_O): $(CGI_C)
	cd $(SRC_CGI) && make $(CGI_O)

##############################################################################
# implicit rules

%.cgi : %.c
	$(CC) $(CFLAGS) $(LDFLAGS) $< $(CGI_O) -o $@
