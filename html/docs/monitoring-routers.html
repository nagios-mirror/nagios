<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
<title>Monitoring Routers and Switches</title>

<STYLE type="text/css">
<!--
        .Default { font-family: verdana,arial,serif; font-size: 8pt; }
        .PageTitle { font-family: verdana,arial,serif; font-size: 16pt; font-weight: bold; }
-->      
</STYLE>

</head>

<body bgcolor="#FFFFFF" text="black" class="Default">

<p>
<div align="center">
<img src="images/nagios.jpg" border="0" alt="Nagios" title="Nagios">
<h2 class="PageTitle">Monitoring Routers and Switches</h2>
</div>
</p>

<hr>

<p>
<img src="images/upto.gif" border="0" align="absmiddle">Up To: <a href="toc.html">Contents</a><br>
<img src="images/seealso.gif" border="0" align="absmiddle"> See Also: <a href="monitoring-publicservices.html">Monitoring Publicly Available Services</a>
</p>

<p>
<strong><u>Introduction</u></strong>
</p>

<img src="images/switch.png" border="0" style="float: right">

<p>
This document describes how you can monitor the status of network switches and routers.  Some cheaper "unmanaged" switches and hubs don't have IP addresses and are essentially invisible on your network, so there's not any way to monitor them.  More expensive switches and routers have addresses assigned to them and can be monitored by pinging them or using SNMP to query status information.
</p>

<p>
I'll describe how you can monitor the following things on managed switches, hubs, and routers:
</p>

<p>
<ul>
<li>Packet loss, round trip average</li>
<li>SNMP status information</li>
<li>Bandwith / traffic rate</li>
</ul>
</p>

<p>
<img src="images/note.gif" border="0" align="bottom"> Notes:
</p>

<p>
<ul>
<li>These instructions assume that you've installed Nagios according to the <a href="quickstart.html">quickstart guide</a>.  The sample configuration entries below reference objects that are defined in the sample <i>commands.cfg</i> and <i>localhost.cfg</i> config files.</li><br><br>
<li>For your convenience, the configuration examples given below can be found in a sample <i>switch.cfg</i> config file that gets installed when you following the quickstart guide.  After reading these instructions, just edit the <i>switch.cfg</i> file to customize the host name, IP address, etc. and uncomment the reference to the <i>switch.cfg</i> file in the <i>nagios.cfg</i> file.</li><br><br>
<li>The <i>check_snmp</i> plugin will only get compiled and installed if you have the net-snmp and net-snmp-utils packages installed on your system.  Make sure the plugin exists in <i>/usr/local/nagios/libexec</i> before you continue.  If it doesn't, install net-snmp and net-snmp-utils and recompile/reinstall the Nagios plugins.</li>
</ul>
</p>


<p>
<strong><u>Creating Required Definitions</u></strong>
</p>

<p>
You'll need to create some <a href="objectdefinitions.html">object definitions</a> in order to monitor a new switch.  These definitions can be placed in their own file or added to an already exiting object configuration file.
</p>

<p>
First, its best practice to create a new template for each different type of host you'll be monitoring.  Let's create a new template for switches.
</p>

<p>
<pre>
define host{
	name			generic-switch	; The name of this host template
	use			generic-host	; Inherit default values from the generic-host template
	check_period		24x7		; By default, switches are monitored round the clock
	check_interval		5		; Switches are checked every 5 minutes
	retry_interval		1		; Schedule host check retries at 1 minute intervals
	max_check_attempts		10		; Check each switch 10 times (max)
	check_command		check-host-alive	; Default command to check if routers are "alive"
	notification_period	24x7		; Send notifications at any time
	notification_interval	30		; Resend notifications every 30 minutes
	notification_options	d,r		; Only send notifications for specific host states
	contact_groups		admins		; Notifications get sent to the admins by default
	register			0		; DONT REGISTER THIS - ITS JUST A TEMPLATE
	}
</pre>
</p>

<p>
Notice that the switch template definition is inheriting default values from the <i>generic-host</i> template, which is defined in the sample <i>localhost.cfg</i> file.
</p>

<p>
Next, define a new <a href="objectdefinitions.html#host">host</a> for the switch that references the newly created <i>generic-switch</i> host template.
</p>

<p>
<pre>
define host{
	use		generic-switch		; Inherit default values from a template
	host_name		linksys-srw224p		; The name we're giving to this switch
	alias		Linksys SRW224P Switch	; A longer name associated with the switch
	address		192.168.1.253		; IP address of the switch
	hostgroups	allhosts			; Host groups this switch is associated with
	}
</pre>
</p>

<p>
Add an optional <a href="objectdefinitions.html#hostgroup">hostgroup</a> for switches.  This is useful if you create additional switches in the future and want to view them together in the CGIs.  It can also be useful for <a href="objecttricks.html">object definition tricks</a> that you can use to manage larger configurations later on.
</p>

<p>
<pre>
define hostgroup{
	hostgroup_name	switches		; The name of the hostgroup
	alias		Network Switches	; Long name of the group
	members		linksys-srw224p	; Comma separated list of hosts that belong to this group
	}
</pre>
</p>

<p>
The <i>linksys-srw224p</i> host will be a member of two hostgroups - <i>allhosts</i> (which is referenced in the host definition and defined in <i>localhost.cfg</i>) and <i>switches</i> (which is defined above).
</p>

<p>
<strong><u>Monitoring Packet Loss and RTA</u></strong>
</p>

<p>
Now its time to define some <a href="objectdefinitions.html#service">services</a> that should be associated with the switch.  First off, we should monitor packet loss and round trip average between the Nagios host and the switch.  This can be accomplished by using the <i>check_ping</i> plugin.  A <a href="objectdefinitions.html#command">command definition</a> for using the <i>check_ping</i> plugin that has been defined in the <i>commands.cfg</i> file.  That command definition looks like this...
</p>

<p>
<pre>
define command{
	command_name	check_ping
	command_line	$USER1$/check_ping -H $HOSTADDRESS$ -w $ARG1$ -c $ARG2$ -p 5
	}
</pre>
</p>


<p>
Let's create a service called <i>PING</i> as follows...
</p>

<p>
<pre>
define service{
	use			generic-service	; Inherit values from a template
	host_name			linksys-srw224p	; The name of the host the service is associated with
	service_description	PING		; The service description
	check_command		check_ping!200.0,20%!600.0,60%	; The command used to monitor the service
	normal_check_interval	5	; Check the service every 5 minutes under normal conditions
	retry_check_interval	1	; Re-check the service every minute until its final/hard state is determined
	}
</pre>
</p>

<p>
Notice that the <i>check_command</i> directive is passing "200.0,20%" and "600.0,60%" to the <i>check_ping</i> command, where they are substituted for the $ARG1$ and $ARG2$ macros, respectively.  This means that the PING service will be: </p>

<p>
<ul>
<li>CRITICAL if the round trip average (RTA) is greater than 600 milliseconds or the packet loss is 60% or more</li>
<li>WARNING if the RTA is greater than 200 ms or the packet loss is 20% or more</li>
<li>OK if the RTA is less than 200 ms and the packet loss is less than 20%</li>
</ul>
</p>

<p>
<strong><u>Monitoring SNMP Status Information</u></strong>
</p>

<p>
If your switch or router supports SNMP, you can monitor a lot of information by using the <i>check_snmp</i> plugin.  A <a href="objectdefinitions.html#command">command definition</a> for using the <i>check_snmp</i> plugin that has been defined in the <i>commands.cfg</i> file.  That command definition looks like this...
</p>

<p>
<pre>
define command{
	command_name	check_snmp
	command_line	$USER1$/check_snmp -H $HOSTADDRESS$ $ARG1$
	}
</pre>
</p>

<p>
Monitoring the uptime of a switch is fairly common.  A service definition that would accomplish that looks like this...
</p>

<p>
<pre>
define service{
	use			generic-service	; Inherit values from a template
	host_name			linksys-srw224p
	service_description	Uptime	
	check_command		check_snmp!-C public -o sysUpTime.0
	}
</pre>
</p>

<p>
The check_command directive will pass the "-C public -o sysUpTime.0" options to the $ARG1$ macro in the <i>check_snmp</i> command definitions.  The "-C public" tells the plugin that the SNMP community name is "public" and the "-o sysUpTime.0" is the OID that we want to check.
</p>

<p>
If you want to ensure that a specific port/interface on the switch is in an up state, you could create a service definition like this:
</p>

<p>
<pre>
define service{
	use			generic-service	; Inherit values from a template
	host_name			linksys-srw224p
	service_description	Port 1 Link Status
	check_command		check_snmp!-C public -o ifOperStatus.1 -r 1 -m RFC1213-MIB
	}
</pre>
</p>

<p>
In the example above, the "-o ifOperStatus.1" refers to the OID for the operational status of port 1 on the switch.  The "-r 1" option tells the <i>check_snmp</i> plugin to return an OK state if "1" is found in the SNMP result (1 indicates an "up" state on the port) and CRITICAL if it isn't found.  The "-m RFC1213-MIB" is optional and tells the <i>check_snmp</i> plugin to only load the "RFC1213-MIB" instead of every single MIB that's installed on your system, which can help speed things up.
</p>

<p>
That's it for the SNMP monitoring example.  There are a million things that can be monitored via SNMP, so its up to you to decide what you need and want to monitor.  Good luck!
</p>

<p>
<img src="images/tip.gif" border="0" align="bottom"> Tip:  You can usually find the OIDs that can be monitored on a switch by running the following command (replace <i>192.168.1.253</i> with the IP address of the switch):
<i>snmpwalk -v1 -c public 192.168.1.253 -m ALL .1</i>
</p>

<p>
<strong><u>Monitoring Bandwidth / Traffic Rate</u></strong>
</p>

<p>
If you're monitoring bandwidth usage on your switches or routers using <a href="http://oss.oetiker.ch/mrtg/">MRTG</a>, you can have Nagios alert you when traffic rates exceed thresholds you specify.  The <i>check_mrtgtraf</i> plugin (which is included in the Nagios plugins distribution) allows you to do this.
</p>

<p>
A sample <i>check_local_mrtgtraf</i> command that uses the <i>check_mrtg</i> plugin has been been defined in the <i>commands.cfg</i> file.  It looks like this...
</p>

<p>
<pre>
define command{
	command_name	check_local_mrtgtraf
	command_line	$USER1$/check_mrtgtraf -F $ARG1$ -a $ARG2$ -w $ARG3$ -c $ARG4$ -e $ARG5$
	}
</pre>
</p>

<p>
You need to let the <i>check_mrtgtraf</i> plugin know what log file the MRTG data is being stored in, along with thresholds, etc.  In my example, I'm monitoring one of the ports on the Linksys switch.  The MRTG log file is stored in <i>/var/lib/mrtg/192.168.1.253_1.log</i>.  Here's the service definition I use to monitor the bandwidth data that's stored in the log file...
</p>

<p>
<pre>
define service{
	use			generic-service	; Inherit values from a template
	host_name			linksys-srw224p
	service_description	Port 1 Bandwidth Usage
	check_command		check_local_mrtgtraf!/var/lib/mrtg/192.168.1.253_1.log!AVG!1000000,1000000!5000000,5000000!10
	}
</pre>
</p>

<p>
The values in the <i>check_command</i> directive will be substituted for the $ARGx$ variables in the <i>check_local_mrtgtraf</i> command line when the service is checked.  Here's what the substituted command line looks like:
</p>

<p>
<pre>
/usr/local/nagios/libexec/check_mrtgtraf -F /var/lib/mrtg/192.168.1.253_1.log -a AVG -w 1000000,1000000 -c 5000000,5000000 -e 10
</pre>
</p>

<p>
The "-F /var/lib/mrtg/192.168.1.253_1.log" option tells the plugin which MRTG log file to read from.  The "-a AVG" option tells it that it should use average bandwidth statistics.  The "-w 120000,150000 -c 200000,500000" options are warning and critical threshold values (in bytes) for both incoming and outgoing traffic rates.  The "-e 10" option causes the plugin to return a CRITICAL state if the MRTG log file is older than 10 minutes (it should be updated every 5 minutes).
</p>



<p>
Those are the basics on monitoring switches and routers.  As a reminder, if you modify your configuration files, make sure you <a href="verifyconfig.html">verify your configuration</a> and <a href="startstop.html">restart Nagios</a>.
</p>



<hr>

</body>
</html>